<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Customer Relationship Management | Starbucks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        :root { --sb-forest: #1e3932; --sb-green: #007042; --gold: #cba258; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            transition: 0.5s; 
            background-color: #f0f2f5; 
            min-height: 100vh;
        }
        .dark body { background-color: #0b1613; color: #d4e9e2; }

        /* Sidebar Standard - ƒê·ªìng b·ªô 100% c√°c trang Staff */
        .sidebar-floating { 
            background: var(--sb-forest); 
            width: 70px; 
            height: calc(100vh - 40px); 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            border-radius: 35px; 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 1.5rem 0; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        }

        .nav-icon { 
            width: 46px; 
            height: 46px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 16px; 
            cursor: pointer; 
            color: rgba(255, 255, 255, 0.3); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            margin-bottom: 0.8rem; 
            position: relative; 
        }
        .nav-icon:hover, .active-page { 
            background: rgba(255, 255, 255, 0.15); 
            color: #fff; 
            transform: scale(1.15); 
        }

        /* Tooltip Logic - Ch·ªâ hi·ªán khi di chu·ªôt */
        .tooltip { 
            position: absolute; 
            left: 65px; 
            background: var(--sb-forest); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 10px; 
            font-size: 9px; 
            font-weight: 800; 
            text-transform: uppercase; 
            white-space: nowrap; 
            transform: scale(0); 
            transition: 0.2s; 
            z-index: 1000; 
            pointer-events: none; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-icon:hover .tooltip { transform: scale(1); }

        .logout-btn:hover { 
            background: #ef4444 !important; 
            color: white !important; 
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.4); 
        }

        main { margin-left: 110px; padding: 110px 40px 40px 0; }
        .glass-header { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(15px); 
            left: 110px; 
            width: calc(100% - 130px); 
            border-radius: 25px; 
            top: 15px; 
            height: 75px; 
            z-index: 90; 
            position: fixed; 
            border: 1px solid rgba(0,0,0,0.05); 
        }
        .dark .glass-header { background: rgba(11, 22, 19, 0.8); border-color: rgba(255,255,255,0.05); }

        .bento-card { 
            border-radius: 35px; 
            background: white; 
            border: 1px solid rgba(0,0,0,0.03); 
            transition: 0.4s; 
        }
        .dark .bento-card { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.05); }
        
        .txt-black { font-weight: 800; font-style: italic; text-transform: uppercase; }
        .rank-gold { background: linear-gradient(135deg, #cba258, #8d6e35); color: white; }
        .rank-silver { background: linear-gradient(135deg, #94a3b8, #475569); color: white; }
    </style>
</head>
<body class="flex">

    <aside class="sidebar-floating shadow-2xl">
        <div class="mb-8">
            <img src="https://upload.wikimedia.org/wikipedia/en/d/d3/Starbucks_Corporation_Logo_2011.svg" class="w-9 bg-white p-1 rounded-xl shadow-sm">
        </div>
        <nav class="flex-1">
            <div onclick="location.href='staff-dashboard.html'" class="nav-icon"><i class="fa-solid fa-house-user"></i><span class="tooltip">Dashboard</span></div>
            <div onclick="location.href='staff-tables.html'" class="nav-icon"><i class="fa-solid fa-layer-group"></i><span class="tooltip">Ph·ª•c v·ª• b√†n</span></div>
            <div onclick="location.href='staff-pos.html'" class="nav-icon"><i class="fa-solid fa-cash-register"></i><span class="tooltip">B√°n h√†ng</span></div>
            <div onclick="location.href='staff-crm.html'" class="nav-icon active-page"><i class="fa-solid fa-user-tag"></i><span class="tooltip">Kh√°ch h√†ng</span></div>
            <div onclick="location.href='staff-report.html'" class="nav-icon"><i class="fa-solid fa-file-invoice-dollar"></i><span class="tooltip">K·∫øt ca</span></div>
        </nav>
        <button onclick="handleLogout()" class="nav-icon logout-btn mt-auto">
            <i class="fa-solid fa-power-off"></i>
            <span class="tooltip">ƒêƒÉng xu·∫•t</span>
        </button>
    </aside>

    <header class="glass-header flex justify-between items-center px-10 shadow-lg">
        <div>
            <h1 class="text-xl font-black italic uppercase tracking-tighter text-[#1e3932]">Customer CRM</h1>
            <p class="text-[9px] font-black text-green-500 uppercase tracking-widest">Loyalty & Rewards System</p>
        </div>
        <button onclick="openAddModal()" class="bg-[#1e3932] text-white px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase shadow-lg hover:bg-green-700 transition">Th√™m kh√°ch m·ªõi (UC26)</button>
    </header>

    <main class="w-full">
        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 bento-card p-6 flex gap-4 items-center shadow-sm">
                <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                <input type="text" id="crm-search" oninput="renderCRM()" placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i..." class="flex-1 bg-transparent border-none focus:ring-0 text-sm font-bold">
            </div>

            <div class="col-span-12 bento-card p-8">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-b border-black/5">
                            <th class="pb-4">Kh√°ch h√†ng (UC31)</th>
                            <th class="pb-4">Li√™n h·ªá</th>
                            <th class="pb-4">ƒêi·ªÉm t√≠ch l≈©y (UC28)</th>
                            <th class="pb-4">H·∫°ng (UC29)</th>
                            <th class="pb-4 text-right">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="crm-table-body" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
      // --- 1. KH·ªûI T·∫†O D·ªÆ LI·ªÜU (UC26) ---
// T·∫£i d·ªØ li·ªáu t·ª´ LocalStorage ho·∫∑c d√πng d·ªØ li·ªáu m·∫´u ban ƒë·∫ßu
let customers = JSON.parse(localStorage.getItem('sb_crm_data')) || [
    { id: 1, name: "Nguy·ªÖn VƒÉn A", phone: "0901234567", email: "a@gmail.com", points: 1500, rank: "Gold" },
    { id: 2, name: "Tr·∫ßn Th·ªã B", phone: "0987654321", email: "b@gmail.com", points: 450, rank: "Silver" }
];

// ƒê·ªãnh nghƒ©a quy·ªÅn l·ª£i qu√† t·∫∑ng (UC30)
const RANK_REWARDS = {
    "Member": "Voucher 5%",
    "Silver": "Free 1 Topping / Bill",
    "Gold": "Buy 1 Get 1 Free (B·∫•t k·ª≥)"
};

// --- 2. UC26: TH√äM KH√ÅCH H√ÄNG M·ªöI ---
async function openAddModal() {
    const { value: formValues } = await Swal.fire({
        title: '<span class="txt-black text-lg">ƒêƒÉng k√Ω Partner m·ªõi</span>',
        html:
            '<input id="swal-name" class="swal2-input" placeholder="H·ªç v√† t√™n">' +
            '<input id="swal-phone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">' +
            '<input id="swal-email" class="swal2-input" placeholder="Email">',
        focusConfirm: false,
        confirmButtonColor: '#1e3932',
        confirmButtonText: 'X√ÅC NH·∫¨N (UC26)',
        preConfirm: () => {
            const name = document.getElementById('swal-name').value;
            const phone = document.getElementById('swal-phone').value;
            const email = document.getElementById('swal-email').value;
            
            // AC: Ki·ªÉm tra ƒë·ªãnh d·∫°ng & kh√¥ng tr√πng SƒêT
            if (!name || !phone) return Swal.showValidationMessage('Vui l√≤ng nh·∫≠p T√™n v√† SƒêT');
            if (customers.find(c => c.phone === phone)) return Swal.showValidationMessage('SƒêT ƒë√£ t·ªìn t·∫°i!');
            if (!/^\d{10}$/.test(phone)) return Swal.showValidationMessage('SƒêT kh√¥ng h·ª£p l·ªá (10 s·ªë)');
            
            return { name, phone, email };
        }
    });

    if (formValues) {
        const newCust = { 
            id: Date.now(), 
            ...formValues, 
            points: 0, 
            rank: "Member" 
        };
        customers.push(newCust);
        saveAndRender(); // Ghi log v√† c·∫≠p nh·∫≠t UI
        Swal.fire('Th√†nh c√¥ng!', 'H·ªì s∆° kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u (UC26).', 'success');
    }
}

// --- 3. UC27: C·∫¨P NH·∫¨T TH√îNG TIN ---
async function editCustomer(id) {
    const cust = customers.find(c => c.id === id);
    const { value: formValues } = await Swal.fire({
        title: '<span class="txt-black text-lg">C·∫≠p nh·∫≠t th√¥ng tin (UC27)</span>',
        html:
            `<input id="swal-name" class="swal2-input" value="${cust.name}" placeholder="H·ªç v√† t√™n">` +
            `<input id="swal-phone" class="swal2-input" value="${cust.phone}" placeholder="S·ªë ƒëi·ªán tho·∫°i">` +
            `<input id="swal-email" class="swal2-input" value="${cust.email}" placeholder="Email">`,
        confirmButtonColor: '#1e3932',
        preConfirm: () => {
            const phone = document.getElementById('swal-phone').value;
            // AC: Kh√¥ng cho ph√©p tr√πng SƒêT khi s·ª≠a
            if (customers.find(c => c.phone === phone && c.id !== id)) return Swal.showValidationMessage('SƒêT b·ªã tr√πng!');
            return { 
                name: document.getElementById('swal-name').value, 
                phone, 
                email: document.getElementById('swal-email').value 
            };
        }
    });

    if(formValues) {
        Object.assign(cust, formValues); // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o DB gi·∫£ l·∫≠p
        saveAndRender();
        Swal.fire('ƒê√£ c·∫≠p nh·∫≠t (UC27)!', '', 'success');
    }
}

// --- 4. UC28, UC29 & UC30: T√çCH ƒêI·ªÇM & N√ÇNG H·∫†NG T·ª∞ ƒê·ªòNG ---
function addPoints(id) {
    const cust = customers.find(c => c.id === id);
    const pointsToAdd = 100;
    
    // B·ªî SUNG: L∆∞u l·ªãch s·ª≠ t√≠ch ƒëi·ªÉm (UC28 Task)
    if(!cust.history) cust.history = [];
    cust.history.push({ time: new Date().toLocaleString(), points: pointsToAdd });

    cust.points += pointsToAdd;

    // UC29: So s√°nh ƒëi·ªÉm v·ªõi ng∆∞·ª°ng ƒë·ªÉ t·ª± ƒë·ªông n√¢ng h·∫°ng
    let oldRank = cust.rank;
    if (cust.points >= 1000) cust.rank = "Gold";
    else if (cust.points >= 500) cust.rank = "Silver";
    else cust.rank = "Member";

    // UC30: Hi·ªÉn th·ªã qu√† t·∫∑ng khi thƒÉng h·∫°ng
    if(oldRank !== cust.rank) {
        Swal.fire({
            title: 'THƒÇNG H·∫†NG! (UC29)',
            text: `ThƒÉng l√™n h·∫°ng ${cust.rank}. Qu√† t·∫∑ng nh·∫≠n ƒë∆∞·ª£c: ${RANK_REWARDS[cust.rank]} (UC30)`,
            icon: 'success',
            confirmButtonColor: '#007042'
        });
    } else {
        Swal.fire({
            toast: true, position: 'top-end', icon: 'success',
            title: `ƒê√£ t√≠ch +${pointsToAdd} ƒëi·ªÉm (UC28)`,
            showConfirmButton: false, timer: 1500
        });
    }
    // B·ªî SUNG: Ghi log h·ªá th·ªëng cho Admin (TASK Ghi log)
    let logs = JSON.parse(localStorage.getItem('sb_logs')) || [];
    logs.push({
        time: new Date().toLocaleTimeString(),
        partner: JSON.parse(localStorage.getItem('currentUser'))?.name || "System",
        action: `T√≠ch ƒëi·ªÉm cho KH: ${cust.name} (+${pointsToAdd} PTS)`
    });
    localStorage.setItem('sb_logs', JSON.stringify(logs));

    saveAndRender();
}
   

// --- 5. UC31: XEM CHI TI·∫æT H·ªí S∆† ---
async function viewCustomerDetail(id) {
    const cust = customers.find(c => c.id === id);
    const reward = RANK_REWARDS[cust.rank] || "Ch∆∞a c√≥ qu√† t·∫∑ng";

    Swal.fire({
        title: `<span class="txt-black text-lg">H·ªì s∆° Partner: #${cust.id.toString().slice(-4)}</span>`,
        html: `
            <div class="text-left space-y-3 p-4 bg-gray-50 dark:bg-white/5 rounded-3xl border border-black/5">
                <p class="text-[10px] font-black uppercase text-gray-400">Th√¥ng tin c√° nh√¢n (UC31)</p>
                <p class="text-sm font-bold text-[#1e3932] dark:text-white">T√™n: ${cust.name}</p>
                <p class="text-sm font-bold">SƒêT: ${cust.phone}</p>
                <p class="text-sm">Email: ${cust.email}</p>
                <hr class="border-black/5">
                <p class="text-[10px] font-black uppercase text-green-600">Quy·ªÅn l·ª£i h·∫°ng ${cust.rank} (UC30)</p>
                <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800">
                    <p class="text-xs font-black text-green-700 dark:text-green-400 uppercase italic">üéÅ Qu√† t·∫∑ng: ${reward}</p>
                </div>
            </div>
        `,
        confirmButtonText: 'ƒê√ìNG',
        confirmButtonColor: '#1e3932'
    });
}

// --- 6. H·ªÜ TH·ªêNG L∆ØU TR·ªÆ & HI·ªÇN TH·ªä ---
function saveAndRender() {
    localStorage.setItem('sb_crm_data', JSON.stringify(customers)); // L∆∞u DB
    renderCRM(); // C·∫≠p nh·∫≠t UI
}

function renderCRM() {
    const search = document.getElementById('crm-search').value.toLowerCase();
    const body = document.getElementById('crm-table-body');
    const filtered = customers.filter(c => c.name.toLowerCase().includes(search) || c.phone.includes(search));

    body.innerHTML = filtered.map(c => `
        <tr class="border-b border-black/5 hover:bg-gray-50 transition cursor-pointer" onclick="viewCustomerDetail(${c.id})">
            <td class="py-5 font-bold">${c.name}</td>
            <td class="py-5 text-gray-500 font-medium">${c.phone}</td>
            <td class="py-5"><span class="bg-green-50 text-green-700 px-3 py-1 rounded-full font-black italic">${c.points} PTS</span></td>
            <td class="py-5">
                <span class="px-4 py-1 rounded-full text-[9px] font-black uppercase ${c.rank === 'Gold' ? 'rank-gold' : (c.rank === 'Silver' ? 'rank-silver' : 'bg-gray-200 text-gray-600')}">
                    ${c.rank}
                </span>
            </td>
            <td class="py-5 text-right" onclick="event.stopPropagation()">
                <button onclick="addPoints(${c.id})" class="text-green-600 mr-4 hover:scale-120 transition"><i class="fa-solid fa-plus-circle"></i></button>
                <button onclick="editCustomer(${c.id})" class="text-blue-500 hover:scale-120 transition"><i class="fa-solid fa-pen-to-square"></i></button>
            </td>
        </tr>
    `).join('');
}

function handleLogout() {
    Swal.fire({
        title: 'K·∫æT TH√öC PHI√äN?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'ƒêƒÇNG XU·∫§T'
    }).then((res) => {
        if(res.isConfirmed) {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    });
}

// T·ª± ƒë·ªông t·∫£i danh s√°ch khi m·ªü trang
window.onload = renderCRM;
    </script>
</body>
</html>