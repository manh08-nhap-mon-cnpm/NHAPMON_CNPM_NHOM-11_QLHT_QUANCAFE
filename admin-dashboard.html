<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Starbucks Admin | BI Analytics Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        :root { --sb-forest: #1e3932; --sb-green: #007042; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f2f5; transition: 0.5s; }
        .sidebar-floating { background: var(--sb-forest); width: 70px; height: calc(100vh - 40px); position: fixed; top: 20px; left: 20px; border-radius: 35px; z-index: 100; display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; }
        .nav-icon { width: 46px; height: 46px; display: flex; align-items: center; justify-content: center; border-radius: 16px; cursor: pointer; color: rgba(255, 255, 255, 0.3); transition: 0.3s; margin-bottom: 0.8rem; position: relative; }
        .nav-icon:hover, .active-page { background: rgba(255, 255, 255, 0.15); color: #fff; }
        .tooltip { position: absolute; left: 65px; background: var(--sb-forest); color: white; padding: 6px 12px; border-radius: 10px; font-size: 9px; font-weight: 800; text-transform: uppercase; white-space: nowrap; transform: scale(0); transition: 0.2s; z-index: 1000; pointer-events: none; }
        .nav-icon:hover .tooltip { transform: scale(1); }
        main { margin-left: 110px; padding: 110px 40px 40px 0; }
        .glass-header { background: rgba(240, 242, 245, 0.8); backdrop-filter: blur(15px); left: 110px; width: calc(100% - 130px); border-radius: 25px; top: 15px; height: 75px; z-index: 90; position: fixed; border: 1px solid rgba(0,0,0,0.05); }
        .bento-card { border-radius: 30px; background: white; border: 1px solid rgba(0,0,0,0.02); overflow: hidden; }
        .dark body { background-color: #0b1613; color: #d4e9e2; }
        .dark .bento-card { background: #162621; border-color: rgba(255,255,255,0.05); }
        .txt-black { font-weight: 800; font-style: italic; text-transform: uppercase; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--sb-green); border-radius: 10px; }
    </style>
</head>
<body class="flex">

    <aside class="sidebar-floating shadow-2xl">
        <div class="mb-8"><img src="https://upload.wikimedia.org/wikipedia/en/d/d3/Starbucks_Corporation_Logo_2011.svg" class="w-9 bg-white p-1 rounded-xl"></div>
        <nav class="flex-1">
            <div onclick="location.href='admin-dashboard.html'" class="nav-icon active-page"><i class="fa-solid fa-chart-pie"></i><span class="tooltip">Báo cáo</span></div>
            <div onclick="location.href='admin-tables.html'" class="nav-icon"><i class="fa-solid fa-layer-group"></i><span class="tooltip">Sơ đồ bàn</span></div>
            <div onclick="location.href='admin-menu.html'" class="nav-icon"><i class="fa-solid fa-mug-hot"></i><span class="tooltip">Thực đơn</span></div>
            <div onclick="location.href='inventory.html'" class="nav-icon"><i class="fa-solid fa-boxes-stacked"></i><span class="tooltip">Kho hàng</span></div>
            <div onclick="location.href='hr.html'" class="nav-icon"><i class="fa-solid fa-user-shield"></i><span class="tooltip">Nhân sự</span></div>
            <div onclick="location.href='admin-settings.html'" class="nav-icon"><i class="fa-solid fa-gears"></i><span class="tooltip">Cài đặt</span></div>
        </nav>
        <button onclick="handleLogout()" class="nav-icon mt-auto text-red-400"><i class="fa-solid fa-power-off"></i></button>
    </aside>

    <header class="glass-header flex justify-between items-center px-10 shadow-lg">
        <div>
            <p class="text-[9px] font-black tracking-[0.4em] text-gray-400 uppercase italic">BI Intelligence</p>
            <h1 class="text-xl txt-black text-[#1e3932] dark:text-white">Báo Cáo Doanh Thu</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center bg-white dark:bg-white/5 px-4 py-2 rounded-xl shadow-sm gap-2">
                <i class="fa-solid fa-calendar text-green-600"></i>
                <input type="date" id="date-picker" onchange="renderData()" class="bg-transparent border-none text-[10px] font-black uppercase focus:ring-0 cursor-pointer">
            </div>
            <button onclick="toggleDarkMode()" class="w-10 h-10 bento-card flex items-center justify-center shadow-sm"><i id="mode-icon" class="fa-solid fa-moon"></i></button>
        </div>

        <div class="flex items-center gap-3">
    <button onclick="location.href='admin-report.html'" class="flex items-center gap-2 bg-[#007042] text-white px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase shadow-lg hover:bg-[#1e3932] transition-all">
        <i class="fa-solid fa-chart-line"></i>
        Báo cáo chi tiết (UC40)
    </button>
    
    <button onclick="toggleDarkMode()" class="w-10 h-10 bento-card flex items-center justify-center shadow-sm">
        <i id="mode-icon" class="fa-solid fa-moon"></i>
    </button>
</div>
    </header>

    <main class="flex-1">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 mr-5">
            <div class="bento-card p-8 border-l-[12px] border-[#007042] shadow-sm">
                <p id="label-date" class="text-[9px] font-black text-gray-400 uppercase mb-2">Doanh thu ngày</p>
                <h2 id="display-day-rev" class="text-4xl font-black text-[#1e3932] dark:text-green-500 italic">12,000,000đ</h2>
            </div>
            <div class="bento-card p-8 border-l-[12px] border-[#cba258] shadow-sm">
                <p class="text-[9px] font-black text-gray-400 uppercase mb-2">Chỉ tiêu tháng (UC41)</p>
                <h2 class="text-4xl font-black text-[#1e3932] dark:text-[#cba258] italic">300,000,000đ</h2>
            </div>
            <div class="bento-card p-8 bg-[#1e3932] text-white shadow-xl">
                <p class="text-[9px] font-black text-white/50 uppercase mb-2">Số đơn hàng</p>
                <h2 id="display-order-count" class="text-4xl font-black italic">128</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 mr-5">
            <div class="bento-card p-10 lg:col-span-2 shadow-sm">
                <h3 class="text-lg txt-black mb-8 italic">Phân Tích Dòng Tiền (UC40)</h3>
                <div class="h-[320px]"><canvas id="mainChart"></canvas></div>
            </div>

            <div class="bento-card p-8 flex flex-col shadow-sm">
                <h3 class="text-[11px] font-black uppercase mb-6 text-gray-400 italic border-b border-black/5 pb-4">Chi tiết hóa đơn (UC42)</h3>
                <div id="invoice-list" class="space-y-3 overflow-y-auto max-h-[360px] pr-2 custom-scroll">
                </div>
            </div>
        </div>
    </main>

    <script>
        document.getElementById('date-picker').valueAsDate = new Date();
        let mainChart;

        function renderData() {
            const logs = JSON.parse(localStorage.getItem('sb_logs')) || [];
            const selectedDate = document.getElementById('date-picker').value;
            const dateDisplay = new Date(selectedDate).toLocaleDateString('vi-VN');
            
            // Lọc hóa đơn từ log thực tế
            const dayInvoices = logs.filter(l => l.action.includes("Thanh toán"));
            
            let totalReal = 0;
            dayInvoices.forEach(inv => {
                totalReal += parseInt(inv.total.replace(/\D/g,'')) || 0;
            });

            // Gán số: Mặc định 12 triệu nếu chưa có đơn thực tế
            document.getElementById('display-day-rev').innerText = (totalReal > 0 ? totalReal : 12000000).toLocaleString() + 'đ';
            document.getElementById('display-order-count').innerText = dayInvoices.length || "128";
            document.getElementById('label-date').innerText = `Doanh thu ngày ${dateDisplay}`;

            // Vẽ bảng hóa đơn chi tiết (UC42)
            const list = document.getElementById('invoice-list');
            if(dayInvoices.length === 0) {
                list.innerHTML = `
                    <div class="p-4 bg-gray-50 dark:bg-white/5 rounded-2xl border border-black/5">
                        <p class="text-[10px] font-black text-green-600">${dateDisplay} - 14:20:00</p>
                        <p class="text-[11px] font-bold italic uppercase opacity-50">Hóa đơn mẫu #001</p>
                        <p class="text-right text-sm font-black">1.200.000đ</p>
                    </div>`;
            } else {
                list.innerHTML = dayInvoices.reverse().map(inv => `
                    <div class="p-4 bg-gray-50 dark:bg-white/5 rounded-2xl border border-black/5 mb-2 hover:border-green-500 transition-all">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-black text-green-600">${dateDisplay} - ${inv.time}</span>
                            <span class="text-[9px] font-bold opacity-30 uppercase">${inv.partner}</span>
                        </div>
                        <p class="text-[11px] font-bold italic uppercase text-gray-500">${inv.action}</p>
                        <p class="text-right text-sm font-black text-[#1e3932] dark:text-green-500">${inv.total}</p>
                    </div>`).join('');
            }

            // Cập nhật biểu đồ
            const chartVals = dayInvoices.length > 0 ? dayInvoices.map(i => parseInt(i.total.replace(/\D/g,''))) : [3000000, 5000000, 2000000, 2000000];
            updateChart(chartVals);
        }

        function updateChart(vals) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vals.map((_, i) => 'Bill ' + (i+1)),
                    datasets: [{ label: 'VNĐ', data: vals, backgroundColor: '#007042', borderRadius: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('hub_theme', isDark ? 'dark' : 'light');
            document.getElementById('mode-icon').className = isDark ? 'fa-solid fa-sun text-amber-400' : 'fa-solid fa-moon text-blue-500';
        }

        function handleLogout() {
            Swal.fire({ title: 'LOGOUT?', icon: 'warning', showCancelButton: true }).then(r => { 
                if(r.isConfirmed) { localStorage.removeItem('currentUser'); location.href='index.html'; } 
            });
        }

        window.onload = () => {
            const theme = localStorage.getItem('hub_theme') || 'light';
            if(theme === 'dark') document.documentElement.classList.add('dark');
            renderData();
        };

        window.addEventListener('storage', (e) => { if (e.key === 'sb_logs') renderData(); });
    </script>
</body>
</html>