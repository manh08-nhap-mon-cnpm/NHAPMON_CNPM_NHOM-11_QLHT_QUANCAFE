<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Starbucks Admin | Inventory UC20-23 Full Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        :root { --sb-forest: #1e3932; --sb-green: #007042; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .txt-black { font-weight: 800; font-style: italic; text-transform: uppercase; letter-spacing: -0.05em; }
        .bento-card { border-radius: 30px; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        .progress-bar { height: 8px; border-radius: 10px; background: #f1f5f9; overflow: hidden; }
        .progress-fill { height: 100%; transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        /* Sidebar giống các trang trước của mày */
        .sidebar-floating { 
    background: #1e3932; width: 70px; height: calc(100vh - 40px); 
    position: fixed; top: 20px; left: 20px; border-radius: 35px; 
    z-index: 100; display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; 
}

.nav-icon { 
    width: 46px; height: 46px; display: flex; align-items: center; justify-content: center; 
    border-radius: 16px; cursor: pointer; color: rgba(255, 255, 255, 0.3); 
    transition: 0.3s; margin-bottom: 0.8rem; position: relative; 
}

.nav-icon:hover, .active-page { 
    background: rgba(255, 255, 255, 0.15); color: #fff; transform: scale(1.1); 
}

/* Tooltip hiện ra khi rê chuột vào */
.tooltip { 
    position: absolute; left: 65px; background: #1e3932; color: white; 
    padding: 6px 12px; border-radius: 10px; font-size: 9px; font-weight: 800; 
    text-transform: uppercase; white-space: nowrap; transform: scale(0); 
    transition: 0.2s; z-index: 1000; pointer-events: none;
}

.nav-icon:hover .tooltip { transform: scale(1); }
    </style>
</head>
<body class="p-6">

    <aside class="sidebar-floating shadow-2xl">
    <div class="mb-8">
        <img src="https://upload.wikimedia.org/wikipedia/en/d/d3/Starbucks_Corporation_Logo_2011.svg" class="w-9 bg-white p-1 rounded-xl shadow-sm">
    </div>
    <nav class="flex-1">
        <div onclick="location.href='admin-dashboard.html'" class="nav-icon" id="nav-dash">
            <i class="fa-solid fa-chart-pie"></i>
            <span class="tooltip">Báo cáo</span>
        </div>
        <div onclick="location.href='admin-tables.html'" class="nav-icon" id="nav-tables">
            <i class="fa-solid fa-layer-group"></i>
            <span class="tooltip">Sơ đồ bàn</span>
        </div>
        <div onclick="location.href='admin-menu.html'" class="nav-icon" id="nav-menu">
            <i class="fa-solid fa-mug-hot"></i>
            <span class="tooltip">Thực đơn</span>
        </div>
        <div onclick="location.href='inventory.html'" class="nav-icon" id="nav-inv">
            <i class="fa-solid fa-boxes-stacked"></i>
            <span class="tooltip">Kho hàng</span>
        </div>
        <div onclick="location.href='hr.html'" class="nav-icon" id="nav-hr">
            <i class="fa-solid fa-user-shield"></i>
            <span class="tooltip">Nhân sự</span>
        </div>
        <div onclick="location.href='admin-settings.html'" class="nav-icon" id="nav-set">
            <i class="fa-solid fa-gears"></i>
            <span class="tooltip">Cài đặt</span>
        </div>
    </nav>
    <button onclick="handleLogout()" class="nav-icon logout-btn mt-auto">
        <i class="fa-solid fa-power-off"></i>
        <span class="tooltip">Đăng xuất</span>
    </button>
</aside>

    <main class="ml-24">
        <div class="flex justify-between items-center mb-10">
            <div>
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Package 4: Kho & Nguyên Liệu</p>
                <h1 class="text-3xl txt-black text-[#1e3932]">Inventory Hub</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="uc20_AddMaterial()" class="px-6 py-3 bg-white border border-gray-200 rounded-2xl text-[10px] font-black uppercase hover:bg-gray-50">+ Nguyên Liệu (UC20)</button>
                <button onclick="uc22_OpenImportForm()" class="px-6 py-3 bg-[#1e3932] text-white rounded-2xl text-[10px] font-black uppercase shadow-lg">+ Nhập Kho (UC22)</button>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-8">
                <div class="bento-card p-8">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="txt-black text-sm text-[#1e3932]">Bảng Kiểm Kê Tồn Kho (UC21)</h3>
                        <input type="text" placeholder="Tìm nguyên liệu..." class="bg-gray-100 border-none rounded-xl px-4 py-2 text-xs focus:ring-2 ring-[#007042]">
                    </div>
                    <div id="inventory-list" class="grid grid-cols-2 gap-6">
                        </div>
                </div>
            </div>

            <div class="col-span-4 space-y-6">
                <div class="bento-card p-6 bg-[#1e3932] text-white">
                    <h4 class="text-[10px] font-black uppercase text-green-400 mb-4 italic">Hệ thống Trừ Kho Tự Động (UC23)</h4>
                    <div class="space-y-2 mb-6">
                        <button onclick="uc23_SimulateSale('Latte')" class="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl text-[9px] font-black uppercase transition">Bán 1 Caffè Latte</button>
                        <button onclick="uc23_SimulateSale('Espresso')" class="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl text-[9px] font-black uppercase transition">Bán 1 Espresso</button>
                    </div>
                    <div id="audit-logs" class="space-y-3 h-64 overflow-y-auto pr-2 text-[9px] font-bold scrollbar-hide">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DATA KHỞI TẠO (UC20, 21) ---
        const defaultMaterials = [
            { id: 'RM01', name: "Hạt Cà Phê Espresso", stock: 5000, unit: "gram", min: 1000, hasInvoice: true },
            { id: 'RM02', name: "Sữa Tươi Dalat Milk", stock: 10000, unit: "ml", min: 2000, hasInvoice: true },
            { id: 'RM03', name: "Syrup Caramel", stock: 5, unit: "chai", min: 2, hasInvoice: false }
        ];

        // CÔNG THỨC (UC23)
        const recipeBook = {
            "Latte": [ { id: 'RM01', qty: 18 }, { id: 'RM02', qty: 250 } ],
            "Espresso": [ { id: 'RM01', qty: 18 } ]
        };

        // LẤY DỮ LIỆU TỪ LOCALSTORAGE (LƯU CLJ THÌ LẤY Ở ĐÂY)
        let inventory = JSON.parse(localStorage.getItem('starbucks_inv')) || defaultMaterials;

        // --- HÀM LƯU DỮ LIỆU (CHỐT HẠ) ---
        function saveAndRender() {
            localStorage.setItem('starbucks_inv', JSON.stringify(inventory));
            renderUI();
        }

        // --- UC21: XEM TỒN KHO ---
        function renderUI() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = inventory.map(item => {
                const percent = Math.min((item.stock / (item.min * 5)) * 100, 100);
                const color = item.stock <= item.min ? '#ef4444' : '#007042';
                return `
                    <div class="p-6 border border-gray-100 rounded-[25px] hover:shadow-xl transition group">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-xs font-black text-[#1e3932] uppercase">${item.name}</h4>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="uc20_Delete('${item.id}')" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <p class="text-2xl font-black italic mb-2">${item.stock.toLocaleString()} <span class="text-[10px] text-gray-400 not-italic uppercase">${item.unit}</span></p>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${percent}%; background: ${color}"></div></div>
                    </div>
                `;
            }).join('');
        }

        // --- UC20: THÊM NGUYÊN LIỆU ---
        async function uc20_AddMaterial() {
            const { value: formValues } = await Swal.fire({
                title: 'THÊM NGUYÊN LIỆU (UC20)',
                html: `<input id="n-name" class="swal2-input" placeholder="Tên nguyên liệu">
                       <input id="n-unit" class="swal2-input" placeholder="Đơn vị (gram, ml...)">
                       <input id="n-min" type="number" class="swal2-input" placeholder="Định mức tối thiểu">`,
                preConfirm: () => {
                    return {
                        id: 'RM' + Date.now(),
                        name: document.getElementById('n-name').value,
                        unit: document.getElementById('n-unit').value,
                        min: parseInt(document.getElementById('n-min').value),
                        stock: 0, hasInvoice: false
                    }
                }
            });
            if (formValues.name) {
                inventory.push(formValues);
                addLog(`Admin thêm mới nguyên liệu: ${formValues.name}`);
                saveAndRender();
            }
        }

        // --- UC20: XÓA (CHECK AC: KHÔNG XÓA NẾU CÓ PHIẾU NHẬP) ---
        function uc20_Delete(id) {
            const item = inventory.find(i => i.id === id);
            if (item.hasInvoice) {
                return Swal.fire('Lỗi (UC20)', 'Không cho phép xóa nguyên liệu đã phát sinh phiếu nhập!', 'error');
            }
            inventory = inventory.filter(i => i.id !== id);
            addLog(`Admin xóa nguyên liệu: ${item.name}`);
            saveAndRender();
        }

        // --- UC22: NHẬP KHO (CẬP NHẬT TỒN KHO) ---
        async function uc22_OpenImportForm() {
            const { value: amount } = await Swal.fire({
                title: 'LẬP PHIẾU NHẬP (UC22)',
                input: 'number',
                inputLabel: 'Nhập số lượng hạt Cà Phê thêm vào (gram)',
                inputAttributes: { min: 1 },
                showCancelButton: true
            });
            if (amount > 0) {
                const item = inventory.find(i => i.id === 'RM01');
                item.stock += parseInt(amount);
                item.hasInvoice = true; // Đánh dấu để không cho xóa (UC20)
                addLog(`Nhập kho: +${amount}g ${item.name}.`);
                saveAndRender();
                Swal.fire('Thành công', 'Tồn kho đã được cộng dồn!', 'success');
            }
        }

        // --- UC23: TRỪ KHO TỰ ĐỘNG (LOGIC QUAN TRỌNG NHẤT) ---
        function uc23_SimulateSale(itemName) {
            const recipe = recipeBook[itemName];
            let canDeduct = true;
            let errorMsg = "";

            // 1. Kiểm tra tồn kho trước (Check AC: Không cho tồn kho âm)
            recipe.forEach(ing => {
                const material = inventory.find(m => m.id === ing.id);
                if (material.stock < ing.qty) {
                    canDeduct = false;
                    errorMsg = material.name;
                }
            });

            if (!canDeduct) {
                Swal.fire('Ngừng thao tác (UC23)', `Nguyên liệu "${errorMsg}" không đủ để làm món ${itemName}!`, 'error');
                addLog(`[LỖI] Thiếu ${errorMsg} cho món ${itemName}`, 'text-red-400');
                return;
            }

            // 2. Thực hiện trừ kho (Task: Cập nhật DB và UI)
            recipe.forEach(ing => {
                const material = inventory.find(m => m.id === ing.id);
                material.stock -= ing.qty;
                addLog(`Hệ thống trừ ${ing.qty}${material.unit} ${material.name} (Bán ${itemName})`, 'text-green-400');
            });

            saveAndRender();
        }

        function addLog(msg, colorClass = 'text-white/50') {
            const logs = document.getElementById('audit-logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML = `<p class="${colorClass} border-l-2 border-green-500 pl-2 animate-pulse">[${time}] ${msg}</p>` + logs.innerHTML;
        }

        window.onload = renderUI;
    </script>
</body>
</html>